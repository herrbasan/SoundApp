<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Engine</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background: #1a1a1a;
            color: #888;
            font-size: 12px;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
        }
        .indicator.active {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }
        .indicator.playing {
            background: #2196f3;
            box-shadow: 0 0 8px #2196f3;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #0d0d0d;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            opacity: 0.8;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="status">
        <div class="indicator" id="status-indicator"></div>
        <span id="status-text">Audio Engine Initializing...</span>
    </div>
    <div class="log" id="log"></div>

    <script language="JavaScript" type="module">
        // Top-level await in module script
        console.log('[Engine] === SCRIPT START ===');
        
        // Load dependencies sequentially with explicit logging
        console.log('[Engine] Step 1: Importing nui_ut...');
        const { default: ut } = await import('../libs/nui/nui_ut.js');
        window.ut = ut;
        console.log('[Engine] Step 1 DONE: nui_ut loaded');
        
        console.log('[Engine] Step 2: Importing chiptune...');
        const { ChiptuneJsPlayer } = await import('../libs/chiptune/chiptune3.js');
        window.chiptune = ChiptuneJsPlayer;
        console.log('[Engine] Step 2 DONE: chiptune loaded');
        
        console.log('[Engine] Step 3: Importing midi...');
        let midiModule;
        try {
            midiModule = await import('../js/midi/midi.js');
            console.log('[Engine] Step 3a: midi module object:', midiModule);
            console.log('[Engine] Step 3b: midiModule keys:', Object.keys(midiModule));
        } catch (e) {
            console.error('[Engine] Step 3 FAILED:', e);
        }
        
        console.log('[Engine] Step 4: Extracting MidiPlayer...');
        let MidiPlayer = midiModule?.MidiPlayer;
        console.log('[Engine] Step 4a: MidiPlayer from midiModule.MidiPlayer:', typeof MidiPlayer);
        
        if (!MidiPlayer && midiModule?.default) {
            MidiPlayer = midiModule.default;
            console.log('[Engine] Step 4b: Using midiModule.default instead');
        }
        
        window.midi = MidiPlayer || null;
        console.log('[Engine] Step 5: window.midi set to:', typeof window.midi, window.midi);
        
        console.log('[Engine] Step 6: Loading engines.js...');
        require('../js/engines.js');
        console.log('[Engine] === SCRIPT END ===');
        
        // Minimal status UI for debugging
        const indicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const logEl = document.getElementById('log');
        
        function log(msg) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Override console.log to also show in UI
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            log(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
        };
        
        // Status updates
        window.updateStatus = function(state) {
            indicator.className = 'indicator ' + state;
            if (state === 'active') {
                statusText.textContent = 'Audio Engine Active';
            } else if (state === 'playing') {
                statusText.textContent = 'Audio Engine Playing';
            } else {
                statusText.textContent = 'Audio Engine Idle';
            }
        };
        
        log('Audio Engine window loaded');
    </script>
</body>
</html>
