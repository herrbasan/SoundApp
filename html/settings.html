<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
        html, body { background-color: #323232 !important; }
        main { opacity: 0; }
        main.ready { opacity: 1; transition: opacity 0.1s ease-in; }
    </style>
    <title>Settings - SoundApp</title>
    <link media="all" rel="stylesheet" type="text/css" href="../css/fonts.css">
    <link media="all" rel="stylesheet" type="text/css" href="../libs/nui/css/nui_main.css">
    <link media="all" rel="stylesheet" type="text/css" href="../libs/nui/css/nui_select.css">
    <link media="all" rel="stylesheet" type="text/css" href="../libs/nui/css/nui_app.css">
    <link rel="stylesheet" href="../css/window.css">
</head>

<body class="dark" style="background-color:#323232">
    <div class="nui-app" style="background-color:#323232">
        <div class="nui-title-bar">
            <div class="title">
                <div class="nui-icon-container">
                    <i>settings</i>
                </div>
                <div class="label">Settings</div>
            </div>
            <div class="controls">
                <div class="nui-icon-container close"><i>close</i></div>
            </div>
        </div>
        <div class="content settings">
            <main>
                <div class="settings-column">
                    <div class="nui-card">
                        <section class="settings-section">
                            <h2>General</h2>
                            <div class="nui-checkbox">
                                <input type="checkbox" id="darkThemeToggle">
                                <label for="darkThemeToggle">
                                    <strong>Dark Theme</strong>
                                </label>
                            </div>
                            <div class="setting-description">
                                Switch between dark and light theme. Alternative to the Ctrl+X keyboard shortcut.
                            </div>
                            <div class="nui-checkbox" style="margin-top: 1rem;">
                                <input type="checkbox" id="showControlsToggle">
                                <label for="showControlsToggle">
                                    <strong>Show Controls</strong>
                                </label>
                            </div>
                            <div class="setting-description">
                                Show the playback controls bar at the bottom of the main window. Toggle with 'C' key.
                            </div>
                            </section>
                            <hr>
                            <section class="settings-section">
                            <div class="nui-input">
                                <div>
                                    <label>Default Directory</label>
                                    <div class="browse-input">
                                        <div style="position: relative; display: flex; align-items: center;">
                                            <input type="text" id="defaultDirInput" readonly placeholder="No directory set" style="width: 100%; padding-right: 2.5rem;">
                                            <div id="clearDirBtn" class="nui-icon-container" style="position: absolute; right: 0.5rem; cursor: pointer; display: none; opacity: 0.7;">
                                                <i>close</i>
                                            </div>
                                        </div>
                                        <button id="browseBtn" type="button">Browse...</button>
                                    </div>
								<div class="setting-description">
									Optional start folder used for file dialogs and drag & drop convenience.
								</div>
                                </div>
                            </div>
                            <hr>
                            </section>
                             <section class="settings-section">
                        <div class="nui-checkbox" style="margin-top: 1rem;">
                            <input type="checkbox" id="keepRunningInTrayToggle">
                            <label for="keepRunningInTrayToggle">
                                <strong>Keep running in tray</strong>
                            </label>
                        </div>
                        <div class="setting-description">
                            When enabled, closing the main window will hide SoundApp to the tray instead of exiting. Useful for faster restart.
                        </div>
                        </section>
                    </div>
                    
                    <div class="nui-card">
                        <section class="settings-section">
                            <h2>File Associations</h2>
                            <div class="nui-button-container">
                                <button id="registerFilesBtn" type="button" class="nui-button">Register File Types</button>
                                <button id="unregisterFilesBtn" type="reset" class="nui-button secondary">Unregister File Types</button>
                            </div>
                            <div class="restart-notice" id="registryNotice">
                                Done!
                            </div>
                            <div class="setting-description" style="margin-bottom: 1rem;">
                                Register SoundApp as the default handler for supported audio file types in Windows Explorer.
                            </div>
                            <hr>
                            <div class="nui-button-container" style="margin-top: 1rem;">
                                <button id="setDefaultBtn" type="button" class="nui-button">Set as Default Player</button>
                            </div>
                            <div class="setting-description">
                                Opens Windows Default Programs where you can set SoundApp as the default for all audio formats at once.
                            </div>
                        </section>
                    </div>

                    <div class="nui-card">
                        <section>
                            <h2>Module / Tracker</h2>
                            <div class="nui-input">
                                <label>MOD Stereo Separation</label>
                                <select id="modStereoSeparationSelect">
                                    <option value="0">0% (Mono)</option>
                                    <option value="25">25%</option>
                                    <option value="50">50%</option>
                                    <option value="75">75%</option>
                                    <option value="100" selected>100% (Full Amiga stereo)</option>
                                </select>
                                <div class="setting-description">
                                    Stereo width control for tracker/module formats (MOD, XM, S3M, IT). 0% = mono, 100% = full Amiga-style hard stereo panning. Affects MOD files only. Changing this reloads the current file.
                                </div>
                            </div>

                            <div class="nui-input">
                                <label>MOD Interpolation Filter</label>
                                <select id="modInterpolationFilterSelect">
                                    <option value="0" selected>Internal default</option>
                                    <option value="1">No interpolation (zero order hold)</option>
                                    <option value="2">Linear interpolation</option>
                                    <option value="4">Cubic interpolation</option>
                                    <option value="8">Windowed sinc (8 taps, highest quality)</option>
                                </select>
                                <div class="setting-description">
                                    Sample interpolation quality for tracker/module formats. Higher quality reduces aliasing artifacts at the cost of slightly more CPU usage. Affects MOD files only. Changing this reloads the current file.
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <div class="settings-column">
                    

                    <div class="nui-card">
                        <section class="settings-section">
                            <h2>Audio / Quality</h2>
                            
                            <div class="nui-checkbox">
                                <input type="checkbox" id="hqModeToggle">
                                <label for="hqModeToggle">
                                    <strong>Max output sample rate</strong><span style="padding-left: 0.5rem;">(up to device max)</span>
                                </label>
                            </div>
                            <div class="restart-notice" id="hqRestartNotice">
                                Switching audio system...
                            </div>


                            <div class="info-box">
                                <strong>Audio System Info</strong><br>
                                Max supported sample rate: <strong id="maxSampleRate">--</strong><br>
                                Current AudioContext rate: <strong id="currentSampleRate">--</strong>
                            </div>

                            <div class="nui-input">
                                <label>Output Device</label>
                                <select id="outputDeviceSelect">
                                    <option value="">System Default</option>
                                </select>
                                <div class="setting-description">
                                    Choose which audio interface to use for playback. Useful for professionals with multiple interfaces (monitors, headphones, external DACs). Changes take effect immediately.
                                </div>
                            </div>
                            
                            <div class="restart-notice" id="deviceChangeNotice">
                                Switching output device...
                            </div>
                        </section>
                    </div>

                    <div class="nui-card">
                        <section>
                            <h2>Streaming</h2>
                            <div class="nui-input">
                                <label>Buffer Size (chunks)</label>
                                <select id="bufferSizeSelect">
                                    <option value="5">5 (~0.5 sec)</option>
                                    <option value="10" selected>10 (~1 sec) - Default</option>
                                    <option value="15">15 (~1.5 sec)</option>
                                    <option value="20">20 (~2 sec)</option>
                                    <option value="25">25 (~2.5 sec)</option>
                                    <option value="30">30 (~3 sec)</option>
                                    <option value="35">35 (~3.5 sec)</option>
                                    <option value="40">40 (~4 sec)</option>
                                    <option value="45">45 (~4.5 sec)</option>
                                    <option value="50">50 (~5 sec)</option>
                                    <option value="55">55 (~5.5 sec)</option>
                                    <option value="60">60 (~6 sec)</option>
                                </select>
                                <div class="setting-description">
                                    Amount of audio buffered ahead during streaming playback. Higher values prevent dropouts on slower systems or during CPU spikes, but use slightly more memory. Lower values reduce latency. Default works well for most systems.
                                </div>
                            </div>

                            <div class="nui-input">
                                <label>Decoder Threads</label>
                                <select id="decoderThreadsSelect">
                                    <option value="0" selected>Auto (detect CPU cores)</option>
                                    <option value="1">1 thread (minimal CPU)</option>
                                    <option value="2">2 threads</option>
                                    <option value="4">4 threads</option>
                                    <option value="8">8 threads</option>
                                </select>
                                <div class="setting-description">
                                    Number of CPU threads for FFmpeg audio decoding. Auto mode uses all available cores for best performance. Lower values reduce CPU usage on slower systems. Changes take effect when loading the next file.
                                </div>
                            </div>
                        </section>
                    </div>

                    <div class="nui-card">
                        <section>
                            <h2>Mixer</h2>
                            <div class="nui-input">
                                <label>Sync Pre-Buffer (ms)</label>
                                <select id="mixerPreBufferSelect">
                                    <option value="50" selected>50ms (Default - Lowest latency)</option>
                                    <option value="100">100ms</option>
                                    <option value="150">150ms</option>
                                    <option value="200">200ms</option>
                                    <option value="250">250ms</option>
                                    <option value="300">300ms (Safest)</option>
                                </select>
                                <div class="setting-description">
                                    Pre-roll buffer time to ensure synchronous start of all tracks. Increase this value if you experience sync issues or stuttering at the start of playback.
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
        <div class="nui-status-bar"></div>
    </div>

    <script src="../js/window-loader.js"></script>
    <script type="module">
        import { main } from '../js/settings/main.js';

        window.addEventListener('bridge-ready', async (e) => {
            const data = e.detail || {};
            await main.init(data);
            document.querySelector('main').classList.add('ready');
        });
    </script>
</body>

</html>
